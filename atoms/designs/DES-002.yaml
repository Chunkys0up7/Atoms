id: DES-002
type: design
title: Data Layer Architecture with PostgreSQL and Redis
summary: Detailed design for data persistence, caching strategy, and connection pooling
content: |
  # Data Layer Architecture

  ## System Diagram
  ```
  ┌─────────────────────────────────────────────────────────┐
  │                    Application Layer                     │
  └─────────────────────┬──────────────────┬────────────────┘
                        │                  │
                        ▼                  ▼
            ┌──────────────────┐  ┌──────────────────┐
            │   PostgreSQL     │  │      Redis       │
            │   Connection     │  │   Connection     │
            │      Pool        │  │      Pool        │
            │  (PgBouncer)     │  │  (redis-py)      │
            └────────┬─────────┘  └────────┬─────────┘
                     │                     │
                     ▼                     ▼
            ┌──────────────────┐  ┌──────────────────┐
            │  PostgreSQL 15+  │  │    Redis 7+      │
            │                  │  │                  │
            │  - users schema  │  │  - sessions      │
            │  - content       │  │  - cache         │
            │  - audit         │  │  - pub/sub       │
            │  - analytics     │  │  - rate limits   │
            └──────────────────┘  └──────────────────┘
  ```

  ## PostgreSQL Configuration

  ### Connection Pooling (PgBouncer)
  ```ini
  [databases]
  gndp_db = host=localhost port=5432 dbname=gndp_production

  [pgbouncer]
  pool_mode = transaction
  max_client_conn = 1000
  default_pool_size = 25
  reserve_pool_size = 5
  reserve_pool_timeout = 3
  ```

  ### Database Schemas
  ```sql
  -- Users schema
  CREATE SCHEMA users;
  CREATE TABLE users.accounts (...);
  CREATE TABLE users.profiles (...);
  CREATE TABLE users.permissions (...);

  -- Content schema
  CREATE SCHEMA content;
  CREATE TABLE content.atoms (...);
  CREATE TABLE content.modules (...);
  CREATE TABLE content.relationships (...);

  -- Audit schema
  CREATE SCHEMA audit;
  CREATE TABLE audit.events (...);
  CREATE TABLE audit.changes (...);

  -- Analytics schema
  CREATE SCHEMA analytics;
  CREATE TABLE analytics.page_views (...);
  CREATE TABLE analytics.api_metrics (...);
  ```

  ### Indexes Strategy
  ```sql
  -- Frequently queried columns
  CREATE INDEX idx_atoms_type ON content.atoms(type);
  CREATE INDEX idx_atoms_status ON content.atoms(status);
  CREATE INDEX idx_relationships_upstream ON content.relationships(upstream_id);
  CREATE INDEX idx_relationships_downstream ON content.relationships(downstream_id);

  -- Full-text search
  CREATE INDEX idx_atoms_content_fts ON content.atoms
    USING GIN(to_tsvector('english', content));

  -- Partial indexes for active records
  CREATE INDEX idx_active_atoms ON content.atoms(created_at)
    WHERE status != 'deprecated';
  ```

  ### Backup Strategy
  - Full backup: Daily at 2 AM UTC (pg_basebackup)
  - Incremental backup: Every 6 hours (WAL archiving)
  - Point-in-time recovery (PITR) enabled
  - Retention: 30 days for full, 7 days for incremental
  - Backup storage: S3-compatible object storage
  - Backup testing: Weekly restore validation

  ## Redis Configuration

  ### Data Structures
  ```python
  # Sessions (Hash)
  HSET session:{token} user_id {uuid}
  HSET session:{token} expires_at {timestamp}
  EXPIRE session:{token} 604800  # 7 days

  # Cache (String with TTL)
  SET cache:atom:{id} {json_data} EX 3600  # 1 hour

  # Rate limiting (Sorted Set)
  ZADD ratelimit:{user_id} {timestamp} {request_id}
  ZREMRANGEBYSCORE ratelimit:{user_id} 0 {timestamp-1hour}

  # Pub/Sub channels
  PUBLISH notifications:user:{id} {message}
  ```

  ### Redis Sentinel for HA
  ```yaml
  sentinel:
    master_name: gndp-redis-master
    sentinels:
      - host: sentinel1.example.com
        port: 26379
      - host: sentinel2.example.com
        port: 26379
      - host: sentinel3.example.com
        port: 26379
    socket_timeout: 0.5
    retry_on_timeout: true
  ```

  ### Eviction Policy
  ```
  maxmemory: 4gb
  maxmemory-policy: allkeys-lru
  ```

  ## Caching Strategy

  ### Cache-Aside Pattern
  ```python
  async def get_atom(atom_id: str) -> dict:
      # Try cache first
      cached = await redis.get(f"cache:atom:{atom_id}")
      if cached:
          return json.loads(cached)

      # Cache miss - fetch from DB
      atom = await db.fetch_one(
          "SELECT * FROM content.atoms WHERE id = $1",
          atom_id
      )

      # Store in cache
      await redis.setex(
          f"cache:atom:{atom_id}",
          3600,  # 1 hour TTL
          json.dumps(atom)
      )

      return atom
  ```

  ### Cache Invalidation
  - On atom update: Delete cache entry immediately
  - On module update: Delete all related atom cache entries
  - Scheduled: Flush stale entries every 24 hours

  ## Performance Targets
  - Read queries (cached): < 10ms p95
  - Read queries (DB): < 50ms p95
  - Write queries: < 100ms p95
  - Cache hit ratio: > 85%
  - Connection pool utilization: < 80%

metadata:
  priority: high
  status: approved
  owner: infrastructure-team
  reviewers:
    - backend-team
    - dba-team
  created: 2025-12-18
  updated: 2025-12-18
upstream_ids:
  - REQ-002
downstream_ids:
  - PROC-002
  - VAL-002
tags:
  - design
  - database
  - postgresql
  - redis
  - caching
  - performance
