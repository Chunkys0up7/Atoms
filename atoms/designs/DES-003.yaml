id: DES-003
type: design
title: Unified API Gateway with REST and GraphQL
summary: API gateway design supporting both REST and GraphQL protocols with shared authentication and rate limiting
content: |
  # API Gateway Architecture

  ## High-Level Design
  ```
  ┌───────────────────────────────────────────────────────┐
  │                    API Gateway                        │
  │                    (FastAPI)                          │
  │                                                       │
  │  ┌──────────────┐           ┌──────────────┐        │
  │  │  REST API    │           │  GraphQL     │        │
  │  │  /api/v1/*   │           │  /graphql    │        │
  │  └──────┬───────┘           └──────┬───────┘        │
  │         │                          │                 │
  │         └──────────┬───────────────┘                 │
  │                    │                                 │
  │         ┌──────────▼───────────┐                    │
  │         │  Middleware Stack    │                    │
  │         │  - Auth              │                    │
  │         │  - Rate Limiting     │                    │
  │         │  - CORS              │                    │
  │         │  - Logging           │                    │
  │         │  - Compression       │                    │
  │         └──────────┬───────────┘                    │
  └────────────────────┼──────────────────────────────┘
                       │
           ┌───────────┴───────────┐
           │                       │
           ▼                       ▼
  ┌────────────────┐     ┌────────────────┐
  │  Business      │     │  Data Layer    │
  │  Logic Layer   │     │  Services      │
  └────────────────┘     └────────────────┘
  ```

  ## REST API Design

  ### Endpoint Structure
  ```
  /api/v1/atoms              - Atom collection
  /api/v1/atoms/{id}         - Single atom
  /api/v1/atoms/{id}/upstream - Upstream relationships
  /api/v1/atoms/{id}/downstream - Downstream relationships
  /api/v1/modules            - Module collection
  /api/v1/modules/{id}       - Single module
  /api/v1/graph              - Full graph data
  /api/v1/impact/{id}        - Impact analysis
  ```

  ### OpenAPI Specification (sample)
  ```yaml
  openapi: 3.0.0
  info:
    title: GNDP API
    version: 1.0.0

  paths:
    /api/v1/atoms:
      get:
        summary: List all atoms
        parameters:
          - name: type
            in: query
            schema:
              type: string
              enum: [requirement, design, procedure, validation, policy, risk]
          - name: status
            in: query
            schema:
              type: string
              enum: [draft, review, approved, deprecated]
          - name: page
            in: query
            schema:
              type: integer
              default: 1
          - name: limit
            in: query
            schema:
              type: integer
              default: 50
              maximum: 100
        responses:
          '200':
            description: List of atoms
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    data:
                      type: array
                      items:
                        $ref: '#/components/schemas/Atom'
                    pagination:
                      $ref: '#/components/schemas/Pagination'
                    _links:
                      $ref: '#/components/schemas/HATEOASLinks'
  ```

  ### Response Format
  ```json
  {
    "data": [
      {
        "id": "REQ-001",
        "type": "requirement",
        "title": "User Authentication System",
        "summary": "...",
        "_links": {
          "self": "/api/v1/atoms/REQ-001",
          "upstream": "/api/v1/atoms/REQ-001/upstream",
          "downstream": "/api/v1/atoms/REQ-001/downstream"
        }
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 50,
      "total": 150,
      "pages": 3
    },
    "_links": {
      "next": "/api/v1/atoms?page=2&limit=50",
      "last": "/api/v1/atoms?page=3&limit=50"
    }
  }
  ```

  ## GraphQL API Design

  ### Schema Definition
  ```graphql
  type Atom {
    id: ID!
    type: AtomType!
    title: String!
    summary: String!
    content: String
    metadata: AtomMetadata!
    upstream: [Atom!]!
    downstream: [Atom!]!
    tags: [String!]!
    createdAt: DateTime!
    updatedAt: DateTime!
  }

  enum AtomType {
    REQUIREMENT
    DESIGN
    PROCEDURE
    VALIDATION
    POLICY
    RISK
  }

  type AtomMetadata {
    priority: Priority!
    status: Status!
    owner: String!
  }

  enum Priority {
    LOW
    MEDIUM
    HIGH
    CRITICAL
  }

  enum Status {
    DRAFT
    REVIEW
    APPROVED
    DEPRECATED
  }

  type Module {
    id: ID!
    name: String!
    description: String!
    atoms: [Atom!]!
    metadata: ModuleMetadata!
  }

  type Query {
    atom(id: ID!): Atom
    atoms(
      type: AtomType
      status: Status
      tags: [String!]
      limit: Int = 50
      offset: Int = 0
    ): [Atom!]!

    module(id: ID!): Module
    modules: [Module!]!

    downstreamImpact(atomId: ID!, maxDepth: Int = 5): ImpactAnalysis!

    search(query: String!, limit: Int = 20): [SearchResult!]!
  }

  type Mutation {
    createAtom(input: CreateAtomInput!): Atom!
    updateAtom(id: ID!, input: UpdateAtomInput!): Atom!
    deleteAtom(id: ID!): Boolean!
  }

  type Subscription {
    atomUpdated(id: ID!): Atom!
    moduleUpdated(id: ID!): Module!
  }
  ```

  ### Query Complexity Analysis
  ```python
  from graphql import GraphQLError

  MAX_COMPLEXITY = 1000

  complexity_map = {
      'Query.atom': 1,
      'Query.atoms': 10,
      'Atom.upstream': 5,
      'Atom.downstream': 5,
      'Module.atoms': 20,
  }

  def calculate_complexity(query_ast):
      # Calculate based on depth and field selection
      # Reject if exceeds MAX_COMPLEXITY
      pass
  ```

  ## Middleware Stack

  ### 1. Authentication Middleware
  ```python
  from fastapi import Request, HTTPException
  from jose import jwt

  async def auth_middleware(request: Request, call_next):
      token = request.headers.get('Authorization', '').replace('Bearer ', '')

      if not token and requires_auth(request.url.path):
          raise HTTPException(status_code=401, detail="Authentication required")

      try:
          payload = jwt.decode(token, PUBLIC_KEY, algorithms=['RS256'])
          request.state.user = payload
      except jwt.JWTError:
          raise HTTPException(status_code=401, detail="Invalid token")

      return await call_next(request)
  ```

  ### 2. Rate Limiting Middleware
  ```python
  from fastapi import Request, HTTPException
  import redis.asyncio as redis

  rate_limiter = redis.Redis(host='localhost', port=6379)

  async def rate_limit_middleware(request: Request, call_next):
      user_id = getattr(request.state, 'user', {}).get('user_id', request.client.host)

      key = f"ratelimit:{user_id}"
      current = await rate_limiter.incr(key)

      if current == 1:
          await rate_limiter.expire(key, 3600)  # 1 hour window

      limit = 1000 if request.state.user else 100

      if current > limit:
          raise HTTPException(status_code=429, detail="Rate limit exceeded")

      response = await call_next(request)
      response.headers['X-RateLimit-Limit'] = str(limit)
      response.headers['X-RateLimit-Remaining'] = str(max(0, limit - current))

      return response
  ```

  ### 3. CORS Middleware
  ```python
  from fastapi.middleware.cors import CORSMiddleware

  app.add_middleware(
      CORSMiddleware,
      allow_origins=[
          "https://gndp.example.com",
          "http://localhost:3000"
      ],
      allow_credentials=True,
      allow_methods=["GET", "POST", "PUT", "DELETE", "PATCH"],
      allow_headers=["*"],
      expose_headers=["X-RateLimit-Limit", "X-RateLimit-Remaining"]
  )
  ```

  ## Error Handling

  ### Standard Error Response
  ```json
  {
    "error": {
      "code": "ATOM_NOT_FOUND",
      "message": "Atom with ID REQ-999 not found",
      "details": {},
      "correlation_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
  }
  ```

  ### Error Codes
  - `AUTHENTICATION_REQUIRED` - 401
  - `PERMISSION_DENIED` - 403
  - `RESOURCE_NOT_FOUND` - 404
  - `VALIDATION_ERROR` - 422
  - `RATE_LIMIT_EXCEEDED` - 429
  - `INTERNAL_ERROR` - 500

  ## Performance Optimizations
  - Response compression (gzip/brotli)
  - ETag-based caching for GET requests
  - Connection pooling for database
  - DataLoader for GraphQL N+1 query prevention
  - Redis caching for frequently accessed data

metadata:
  priority: high
  status: approved
  owner: backend-team
  reviewers:
    - frontend-team
    - architecture-team
  created: 2025-12-18
  updated: 2025-12-18
upstream_ids:
  - REQ-003
  - REQ-001
  - REQ-002
downstream_ids:
  - PROC-003
  - VAL-003
tags:
  - design
  - api
  - rest
  - graphql
  - gateway
