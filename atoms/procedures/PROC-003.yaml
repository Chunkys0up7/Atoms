id: PROC-003
type: procedure
title: API Gateway Deployment and Rolling Update
summary: Procedure for deploying API gateway changes with zero downtime using blue-green deployment
content: |
  # API Gateway Deployment Procedure

  ## Deployment Strategy: Blue-Green

  ### Pre-Deployment Checklist
  - [ ] All tests passing (unit, integration, E2E)
  - [ ] OpenAPI spec updated
  - [ ] Rate limit configurations reviewed
  - [ ] Breaking changes documented and versioned
  - [ ] Load test results reviewed (target: 10K req/s)

  ## Deployment Steps

  ### 1. Deploy Green Environment
  ```bash
  # Deploy new version to green environment
  kubectl apply -f k8s/api-gateway-green.yaml

  # Wait for all pods ready
  kubectl wait --for=condition=ready pod \
    -l app=api-gateway,version=green \
    --timeout=300s

  # Verify health
  curl https://api-green.internal.example.com/health
  ```

  ### 2. Run Smoke Tests Against Green
  ```bash
  pytest tests/smoke/ --base-url=https://api-green.internal.example.com

  # Test key endpoints
  curl https://api-green.internal.example.com/api/v1/atoms | jq '.data | length'
  curl https://api-green.internal.example.com/graphql \
    -X POST \
    -d '{"query":"{ atoms(limit:10) { id type } }"}'
  ```

  ### 3. Traffic Shifting (Gradual)
  ```bash
  # Shift 10% traffic to green
  kubectl patch service api-gateway \
    --patch '{"spec":{"selector":{"version":"green"},"weight":10}}'

  # Monitor for 5 minutes
  # Check error rates, latency in Grafana

  # If healthy, shift 50%
  kubectl patch service api-gateway \
    --patch '{"spec":{"selector":{"version":"green"},"weight":50}}'

  # Monitor for 10 minutes

  # If healthy, shift 100%
  kubectl patch service api-gateway \
    --patch '{"spec":{"selector":{"version":"green"}}}'
  ```

  ### 4. Decommission Blue Environment
  ```bash
  # Wait 30 minutes for any in-flight requests
  sleep 1800

  # Scale down blue
  kubectl scale deployment api-gateway-blue --replicas=0

  # Clean up after 24 hours
  kubectl delete deployment api-gateway-blue
  ```

  ## Rollback Procedure

  ```bash
  # Immediate rollback to blue
  kubectl patch service api-gateway \
    --patch '{"spec":{"selector":{"version":"blue"}}}'

  # Scale up blue if scaled down
  kubectl scale deployment api-gateway-blue --replicas=3

  # Verify
  curl https://api.example.com/health
  ```

  ## Monitoring During Deployment

  ### Key Metrics
  - HTTP 5xx error rate (target: < 0.1%)
  - HTTP 4xx error rate (acceptable: < 2%)
  - Response time p95 (target: < 200ms)
  - Response time p99 (target: < 500ms)
  - Active connections
  - Rate limit hits

  ### Grafana Dashboard
  https://grafana.example.com/d/api-gateway/

metadata:
  priority: high
  status: approved
  owner: backend-team
  created: 2025-12-18
  updated: 2025-12-18
upstream_ids:
  - DES-003
downstream_ids:
  - VAL-003
tags:
  - procedure
  - deployment
  - api
  - blue-green
