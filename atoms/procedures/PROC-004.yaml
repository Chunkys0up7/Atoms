id: PROC-004
type: procedure
title: Neo4j Synchronization and Maintenance
summary: Procedure for synchronizing YAML atoms to Neo4j and performing routine database maintenance
content: |
  # Neo4j Sync and Maintenance Procedure

  ## Scheduled Sync (Daily at 3 AM UTC)

  ```bash
  # /scripts/daily_neo4j_sync.sh
  #!/bin/bash

  cd /app
  source .venv/bin/activate

  # Run sync
  python scripts/sync_neo4j.py --full

  # Check exit code
  if [ $? -eq 0 ]; then
    echo "✓ Sync completed successfully"

    # Run integrity checks
    python scripts/check_graph_integrity.py

    # Generate metrics
    python scripts/generate_graph_metrics.py

  else
    echo "✗ Sync failed"
    # Alert on-call
    curl -X POST $SLACK_WEBHOOK \
      -d '{"text":"⚠️ Neo4j sync failed"}'
    exit 1
  fi
  ```

  ## Manual Sync Procedure

  ### Full Sync (Complete Rebuild)
  ```bash
  # Backup current graph
  neo4j-admin backup \
    --backup-dir=/backups/neo4j/$(date +%Y%m%d_%H%M%S) \
    --database=gndp

  # Run full sync
  python scripts/sync_neo4j.py \
    --full \
    --dry-run=false \
    --verbose

  # Verify node count
  cypher-shell "MATCH (a:Atom) RETURN count(a) as atom_count"

  # Verify relationship count
  cypher-shell "MATCH ()-[r]->() RETURN count(r) as rel_count"
  ```

  ### Incremental Sync (Changed Atoms Only)
  ```bash
  # Get changed files from git
  CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- atoms/ modules/)

  # Run incremental sync
  python scripts/sync_neo4j.py \
    --incremental \
    --files="$CHANGED_FILES"
  ```

  ## Graph Integrity Checks

  ```python
  # scripts/check_graph_integrity.py

  async def check_integrity():
      issues = []

      # 1. Check for orphaned nodes
      orphans = await find_orphans()
      if orphans:
          issues.append(f"Found {len(orphans)} orphaned atoms")

      # 2. Check for circular dependencies
      cycles = await find_cycles()
      if cycles:
          issues.append(f"Found {len(cycles)} circular dependencies")

      # 3. Check for broken references
      broken_refs = await find_broken_references()
      if broken_refs:
          issues.append(f"Found {len(broken_refs)} broken references")

      # 4. Verify all YAML atoms are in graph
      yaml_ids = set(load_all_atom_ids())
      graph_ids = set(await get_all_graph_atom_ids())
      missing = yaml_ids - graph_ids
      if missing:
          issues.append(f"Missing {len(missing)} atoms in graph")

      # Report
      if issues:
          print("⚠️ Integrity issues found:")
          for issue in issues:
              print(f"  - {issue}")
          return False
      else:
          print("✓ Graph integrity check passed")
          return True
  ```

  ## Maintenance Tasks

  ### Weekly Maintenance (Sunday 4 AM UTC)
  ```bash
  # 1. Compact database
  neo4j-admin store-info --database=gndp
  # If fragmentation > 30%, compact
  neo4j-admin compact --database=gndp

  # 2. Rebuild indexes
  cypher-shell <<EOF
  DROP INDEX atom_type IF EXISTS;
  DROP INDEX atom_status IF EXISTS;
  CREATE INDEX atom_type FOR (a:Atom) ON (a.type);
  CREATE INDEX atom_status FOR (a:Atom) ON (a.status);
  EOF

  # 3. Clear query cache
  cypher-shell "CALL db.clearQueryCaches()"

  # 4. Update statistics
  cypher-shell "CALL db.stats.collect()"
  ```

  ### Monthly Maintenance (1st Sunday 4 AM UTC)
  ```bash
  # Full backup and verification
  neo4j-admin backup --database=gndp
  neo4j-admin check --database=gndp

  # Analyze slow queries
  cypher-shell "CALL dbms.listQueries() YIELD query, elapsedTimeMillis
    WHERE elapsedTimeMillis > 1000
    RETURN query, elapsedTimeMillis
    ORDER BY elapsedTimeMillis DESC"

  # Export metrics for analysis
  cypher-shell "CALL apoc.export.csv.all('metrics.csv', {})"
  ```

  ## Troubleshooting

  ### Issue: Sync Taking Too Long (> 5 minutes)
  ```bash
  # Check database performance
  cypher-shell "CALL dbms.listTransactions() YIELD transactionId, elapsedTimeMillis"

  # Check for lock contention
  cypher-shell "CALL dbms.listLocks()"

  # Solution: Run sync during low-traffic period
  # or increase Neo4j memory allocation
  ```

  ### Issue: Out of Memory
  ```bash
  # Check heap usage
  cypher-shell "CALL dbms.queryJmx('java.lang:type=Memory')
    YIELD attributes RETURN attributes"

  # Solution: Increase heap size in neo4j.conf
  # dbms.memory.heap.max_size=4G
  ```

  ### Issue: Circular Dependencies Detected
  ```bash
  # Find cycles
  cypher-shell "MATCH (a:Atom)-[:DEPENDS_ON*]->(a)
    RETURN DISTINCT a.id as atom_id"

  # Solution: Fix YAML files to break cycles
  # Then run full sync
  ```

metadata:
  priority: high
  status: approved
  owner: infrastructure-team
  created: 2025-12-18
  updated: 2025-12-18
  run_frequency: daily_automated
upstream_ids:
  - DES-004
  - REQ-004
downstream_ids: []
tags:
  - procedure
  - neo4j
  - sync
  - maintenance
