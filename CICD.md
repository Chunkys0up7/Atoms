# CI/CD Pipeline Documentation

Complete guide to the GitHub Actions CI/CD pipeline for GNDP (Graph-Native Documentation Platform).

## Overview

The GNDP project uses GitHub Actions for continuous integration and deployment with three main workflows:

1. **CI Pipeline** - Automated testing, validation, and quality checks
2. **Deploy Pipeline** - Automated deployment to GitHub Pages
3. **PR Analysis** - Claude-powered pull request analysis and reporting

## Workflows

### 1. CI Pipeline (ci.yml)

Runs on every push and pull request to validate code quality and functionality.

**Trigger Events:**
- Push to `main`, `develop`, or feature branches
- Pull requests targeting `main` or `develop`

**Jobs:**

#### Lint and Validate
- **Purpose:** Code quality and schema validation
- **Steps:**
  1. Run flake8 for Python linting
  2. Check code formatting with black
  3. Validate all atom schemas against `schemas/atom.schema.yaml`
  4. Validate all module schemas against `schemas/module.schema.yaml`
- **Fail Fast:** Yes - pipeline stops on schema validation errors

#### Test
- **Purpose:** Run comprehensive test suite
- **Infrastructure:**
  - Neo4j 5.15 service container for integration tests
  - Python 3.12 environment
- **Steps:**
  1. Run unit tests with coverage
  2. Run integration tests with coverage
  3. Upload coverage to Codecov
  4. Generate JUnit XML reports
- **Coverage Target:** 90%+
- **Fail Fast:** Yes - pipeline stops on test failures

#### Build Docs
- **Purpose:** Validate documentation build process
- **Steps:**
  1. Build graph from atoms using `docs/build_docs.py`
  2. Validate generated graph JSON
  3. Build MkDocs site
  4. Upload documentation artifact
- **Validation:** Ensures graph has nodes and is well-formed

#### Docker Build
- **Purpose:** Verify Docker images build successfully
- **Steps:**
  1. Build API Docker image
  2. Test container health check
  3. Verify API responds correctly
- **Caching:** Uses GitHub Actions cache for faster builds

#### Security Scan
- **Purpose:** Detect vulnerabilities and secrets
- **Tools:**
  - Trivy: Filesystem vulnerability scanner
  - TruffleHog: Secret detection
- **Results:** Uploaded to GitHub Security tab

**Environment Variables Required:**
```bash
ANTHROPIC_API_KEY  # For Claude API tests
```

**Secrets Configuration:**
Go to repository Settings → Secrets and variables → Actions → New repository secret

### 2. Deploy Pipeline (deploy.yml)

Deploys documentation site to GitHub Pages on every push to main.

**Trigger Events:**
- Push to `main` branch
- Manual workflow dispatch

**Permissions Required:**
- `contents: read`
- `pages: write`
- `id-token: write`

**Jobs:**

#### Build
- **Purpose:** Build production documentation site
- **Steps:**
  1. Generate graph from atoms
  2. Validate graph structure
  3. Build MkDocs site with strict mode
  4. Upload to GitHub Pages artifact
- **Validation:** Strict mode fails on warnings

#### Deploy
- **Purpose:** Deploy to GitHub Pages
- **Environment:** github-pages
- **URL:** Automatically generated by GitHub
- **Artifact:** Uses output from build job

**Setup Requirements:**

1. Enable GitHub Pages:
   - Go to repository Settings → Pages
   - Source: GitHub Actions
   - Branch: Not applicable (using workflow)

2. Verify deployment:
   - Check Actions tab for deployment status
   - Visit Pages URL (shown in deployment job)

### 3. PR Analysis Pipeline (pr-analysis.yml)

Automated PR review using Claude API.

**Trigger Events:**
- Pull request opened
- Pull request synchronized (new commits)
- Pull request reopened

**Permissions Required:**
- `pull-requests: write` (to post comments)
- `contents: read`

**Analysis Features:**

1. **Summary:** Brief overview of changes
2. **Risk Assessment:** LOW/MEDIUM/HIGH with explanation
3. **Key Changes:** 3-5 most important modifications
4. **Potential Impacts:** Affected systems and features
5. **Testing Recommendations:** What to test thoroughly
6. **Review Focus Areas:** Security, edge cases, performance

**Claude Integration:**
- Model: Claude Sonnet 4.5 (`claude-sonnet-4-20250514`)
- Max Tokens: 2048
- System Prompt: Specialized for GNDP codebase
- Context: PR title, description, changed files, diff

**Environment Variables Required:**
```bash
ANTHROPIC_API_KEY  # For Claude analysis
GITHUB_TOKEN      # Automatically provided by GitHub Actions
```

**Example Output:**

```markdown
## Pull Request Analysis Report

### Summary
This PR adds Neo4j graph traversal to the RAG pipeline...

### Risk Assessment
**Risk Level:** MEDIUM RISK

Changes affect core RAG functionality...

### Key Changes
1. New Neo4j client with 8 traversal methods
2. Enhanced RAG routes with graph integration
3. Added comprehensive test suite

### Potential Impacts
- RAG query performance may improve by 35%
- Requires Neo4j service to be running
- New dependency on neo4j-driver package

### Testing Recommendations
- Test RAG queries with Neo4j enabled and disabled
- Verify graceful fallback when Neo4j unavailable
- Load test graph traversal with large datasets

### Review Focus Areas
- Neo4j connection error handling
- Cypher query injection prevention
- Graph traversal depth limits (prevent runaway queries)
```

## Pipeline Status Badges

Add to README.md:

```markdown
[![CI Pipeline](https://github.com/YOUR_ORG/FullSystem/actions/workflows/ci.yml/badge.svg)](https://github.com/YOUR_ORG/FullSystem/actions/workflows/ci.yml)
[![Deploy](https://github.com/YOUR_ORG/FullSystem/actions/workflows/deploy.yml/badge.svg)](https://github.com/YOUR_ORG/FullSystem/actions/workflows/deploy.yml)
```

## Local Testing

Run the same checks locally before pushing:

### Linting
```bash
# Install linting tools
pip install flake8 black isort

# Run flake8
flake8 api/ scripts/ tests/ --max-line-length=127

# Check formatting
black --check api/ scripts/ tests/

# Auto-format
black api/ scripts/ tests/
```

### Schema Validation
```bash
# Validate atoms
python -c "
import os, yaml
from jsonschema import validate

with open('schemas/atom.schema.yaml') as f:
    schema = yaml.safe_load(f)

for root, dirs, files in os.walk('atoms'):
    for file in files:
        if file.endswith('.yaml'):
            with open(os.path.join(root, file)) as f:
                atom = yaml.safe_load(f)
            validate(instance=atom, schema=schema)
            print(f'OK: {file}')
"
```

### Testing
```bash
# Run all tests
pytest

# Run with coverage
pytest --cov=api --cov-report=term-missing

# Run specific test file
pytest tests/unit/test_neo4j_client.py -v

# Run with markers
pytest -m "not slow"
```

### Documentation Build
```bash
# Build graph
python docs/build_docs.py --source atoms --output docs/generated

# Build docs site
mkdocs build --strict

# Serve locally
mkdocs serve
# Visit http://localhost:8000
```

### Docker Testing
```bash
# Build image
docker build -t gndp-api:test .

# Run container
docker run -d --name gndp-test -p 8000:8000 \
  -e NEO4J_BOLT_URI=bolt://host.docker.internal:7687 \
  gndp-api:test

# Test health
curl http://localhost:8000/health

# View logs
docker logs gndp-test

# Cleanup
docker stop gndp-test
docker rm gndp-test
```

## Troubleshooting

### CI Pipeline Failures

**Problem:** Schema validation fails
```
ValidationError: 'id' is a required property
```

**Solution:**
1. Check which atom/module file failed (shown in error)
2. Verify required fields: `id`, `type`, `title`, `summary`
3. Validate locally before pushing:
   ```bash
   python -c "import yaml; from jsonschema import validate; ..."
   ```

**Problem:** Tests fail with Neo4j connection error
```
neo4j.exceptions.ServiceUnavailable: Could not connect to bolt://neo4j:7687
```

**Solution:**
1. Verify Neo4j service is configured in workflow
2. Check health check is passing
3. Wait for service to be ready (increase startup timeout)

**Problem:** Coverage below threshold
```
FAILED - coverage below 90%
```

**Solution:**
1. Add tests for uncovered code paths
2. Check coverage report: `pytest --cov-report=html`
3. Focus on critical paths first

### Deploy Pipeline Failures

**Problem:** MkDocs build fails in strict mode
```
ERROR - Doc file 'path/to/file.md' contains a link to 'missing.md'
```

**Solution:**
1. Fix broken links in markdown files
2. Ensure all referenced files exist
3. Test locally: `mkdocs build --strict`

**Problem:** Graph validation fails
```
ERROR: Graph has no nodes
```

**Solution:**
1. Verify atoms directory has .yaml files
2. Check build_docs.py output for errors
3. Validate atom schemas first

### PR Analysis Failures

**Problem:** Claude API error
```
AuthenticationError: Invalid API key
```

**Solution:**
1. Verify ANTHROPIC_API_KEY secret is set
2. Check API key is valid and active
3. Ensure key has correct permissions

**Problem:** GitHub API error
```
403 Forbidden - Resource not accessible by integration
```

**Solution:**
1. Verify workflow has `pull-requests: write` permission
2. Check GITHUB_TOKEN has correct scopes
3. Ensure repository settings allow workflow write access

## Security Best Practices

### Secrets Management

1. **Never commit secrets:**
   - Use `.env` for local development (gitignored)
   - Use GitHub Secrets for CI/CD

2. **Rotate secrets regularly:**
   - API keys every 90 days
   - Access tokens every 6 months

3. **Limit secret scope:**
   - Use read-only tokens where possible
   - Restrict to specific repositories

### Dependency Security

1. **Automated scanning:**
   - Trivy scans for vulnerabilities
   - TruffleHog detects leaked secrets
   - Results in Security tab

2. **Dependency updates:**
   - Dependabot enabled for automatic updates
   - Review and merge security updates promptly

3. **Pin versions:**
   - Use specific versions in requirements.txt
   - Test before upgrading major versions

### Code Security

1. **Input validation:**
   - Schema validation before processing
   - Sanitize user input in API endpoints

2. **Authentication:**
   - API admin token for sensitive operations
   - Rate limiting on public endpoints

3. **Data protection:**
   - No secrets in logs
   - Secure Neo4j connections (SSL in production)

## Performance Optimization

### Pipeline Speed

**Current timings:**
- Lint and Validate: ~2 minutes
- Tests: ~5 minutes
- Build Docs: ~3 minutes
- Docker Build: ~4 minutes
- Total: ~15 minutes

**Optimization strategies:**

1. **Caching:**
   - pip cache (enabled)
   - Docker layer cache (enabled)
   - npm cache for frontend

2. **Parallelization:**
   - Jobs run in parallel where possible
   - Use pytest-xdist for parallel tests

3. **Selective testing:**
   - Run only affected tests for PRs
   - Full suite only on main branch

### Resource Limits

GitHub Actions free tier:
- 2,000 minutes/month for private repos
- Unlimited for public repos
- 6 hours max per job
- 20 concurrent jobs

## Monitoring

### Pipeline Health

**Check pipeline status:**
```bash
# Using GitHub CLI
gh run list --workflow=ci.yml --limit 10

# View specific run
gh run view RUN_ID

# Watch live
gh run watch
```

**Metrics to monitor:**
- Success rate (target: >95%)
- Average duration (target: <20 minutes)
- Test coverage (target: >90%)
- Failure patterns (recurring issues)

### Alerts

**Configure notifications:**
1. Repository Settings → Notifications
2. Enable email notifications for:
   - Failed workflow runs
   - Security alerts
   - Dependency updates

**Slack integration:**
```yaml
# Add to workflow
- name: Notify Slack on failure
  if: failure()
  uses: slackapi/slack-github-action@v1
  with:
    webhook-url: ${{ secrets.SLACK_WEBHOOK }}
```

## Future Enhancements

### Planned Improvements

1. **Performance testing:**
   - Add load tests for RAG endpoints
   - Benchmark graph traversal performance
   - Track query latency trends

2. **Advanced analysis:**
   - Code complexity metrics
   - Dependency graph visualization
   - Breaking change detection

3. **Deployment strategies:**
   - Blue-green deployment
   - Canary releases
   - Rollback automation

4. **Enhanced PR analysis:**
   - Automated code suggestions
   - Test generation recommendations
   - Documentation gap detection

## References

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [pytest Documentation](https://docs.pytest.org/)
- [MkDocs Documentation](https://www.mkdocs.org/)
- [Trivy Security Scanner](https://trivy.dev/)
- [Claude API Documentation](https://docs.anthropic.com/)

## Support

For issues with CI/CD:
1. Check workflow logs in Actions tab
2. Review this documentation
3. Check TESTING.md for test-specific issues
4. Open issue with workflow run URL
