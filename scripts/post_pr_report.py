#!/usr/bin/env python3
"""Post a PR comment using GITHUB_TOKEN based on a claude report file.
This script reads the JSON file produced by `scripts/claude_helper.py` and
posts a comment to the PR with a short structured summary. It tolerates
different shapes of model output and avoids posting sensitive content.
"""
import argparse
import os
import sys
import json
import requests
from typing import Any, Dict, Optional

GITHUB_API = "https://api.github.com"


def post_comment(repo: str, pr_number: str, body: str, token: str) -> dict:
    url = f"{GITHUB_API}/repos/{repo}/issues/{pr_number}/comments"
    headers = {"Authorization": f"token {token}", "Accept": "application/vnd.github+json"}
    resp = requests.post(url, headers=headers, json={"body": body}, timeout=15)
    resp.raise_for_status()
    return resp.json()


def read_claude(path: str) -> Optional[Dict[str, Any]]:
    if not os.path.exists(path):
        return None
    with open(path, "r", encoding="utf-8") as fh:
        return json.load(fh)


def normalize_model_output(report: Dict[str, Any]) -> Dict[str, Any]:
    # Accept either {'model_output': {...}} or raw dict
    out = report.get("model_output") if isinstance(report, dict) and "model_output" in report else report
    if out is None:
        return {}
    if isinstance(out, str):
        return {"summary": out}
    if isinstance(out, dict):
        return out
    return {"summary": str(out)}


def redact_summary(s: str) -> str:
    # Basic redaction: remove emails and long numeric IDs
    import re
    s = re.sub(r"[\w\.-]+@[\w\.-]+", "[REDACTED_EMAIL]", s)
    s = re.sub(r"\b\d{9,}\b", "[REDACTED_ID]", s)
    return s


def build_comment(report: Optional[Dict[str, Any]]) -> str:
    if not report:
        return "GNDP Agent: no report available."
    out = normalize_model_output(report)
    summary = redact_summary(out.get("summary", "No summary"))
    risk = out.get("risk_level") or out.get("risk") or "UNKNOWN"
    modules = out.get("affected_modules") or out.get("modules") or []
    reviewers = out.get("suggested_reviewers") or out.get("reviewers") or []

    lines = ["### GNDP Impact Summary", "", f"**Risk level:** {risk}", "", f"**Summary:** {summary}", ""]
    if modules:
        lines.append("**Affected modules:** " + ", ".join(map(str, modules)))
    if reviewers:
        lines.append("**Suggested reviewers:** " + ", ".join(map(str, reviewers)))

    lines.append("\n*This comment was generated by the GNDP Agent. Sensitive data redacted.*")
    return "\n".join(lines)


def main():
    p = argparse.ArgumentParser()
    p.add_argument("--pr", required=True)
    p.add_argument("--claude", required=True)
    args = p.parse_args()

    repo = os.environ.get("GITHUB_REPOSITORY")
    token = os.environ.get("GITHUB_TOKEN")
    if not repo or not token:
        print("Missing GITHUB_REPOSITORY or GITHUB_TOKEN environment variables", file=sys.stderr)
        sys.exit(1)

    report = read_claude(args.claude)
    body = build_comment(report)
    try:
        post_comment(repo, args.pr, body, token)
        print("Posted PR comment")
    except Exception as e:
        print("Failed to post PR comment:", e, file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
